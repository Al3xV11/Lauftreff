<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mittwoch Umfrage</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 600px;
  margin: auto;
  padding: 12px;
}

h2 {
  font-size: 1.3em;
  text-align: center;
}

h3 {
  margin-top: 24px;
}

input {
  width: 100%;
  padding: 12px;
  font-size: 16px; /* verhindert iOS-Zoom */
  margin-bottom: 10px;
  box-sizing: border-box;
}

button {
  display: flex;               /* Flexbox aktiv */
  justify-content: space-between; /* Text links, Zahl rechts */
  align-items: center;         /* Vertikal zentriert */
  width: 100%;
  padding: 14px;
  font-size: 18px;
  margin: 6px 0;
  border-radius: 8px;
  border: none;
  background: #1565c0;   /* Blau */
  color: white;          /* WeiÃŸe Schrift */
  cursor: pointer;
}

button:active {
  background: #0d47a1;   /* dunkleres Blau beim DrÃ¼cken */
}


#weather {
  text-align: center;
  font-size: 1.1em;
  margin-bottom: 16px;
}

ul {
  padding-left: 0;
}

li {
  list-style: none;
  padding: 6px 0;
  line-height: 1.4;
  font-size: 16px;
}
  
.count {
  display: inline-block;
  background-color: #1b5e20; /* dunkelgrÃ¼n */
  color: white;
  border-radius: 50%;
  width: 28px;       /* KreisgrÃ¶ÃŸe */
  height: 28px;
  text-align: center;
  line-height: 28px; /* Zahl zentrieren */
  font-weight: bold;
  font-size: 16px;
}

  
.divider {
  width: 100%;           /* horizontaler Bereich */
  border-top: 2px solid #aaa; /* Linie */
  margin: 12px 0;        /* Abstand oben/unten */
}

.weather-link {
  cursor: pointer;
  text-decoration: underline;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
}

.modal-content {
  background: white;
  color: black;
  margin: 15% auto;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  border-radius: 10px;
}

.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  animation: fadeIn 0.25s ease;
}

.modal-content {
  background: white;
  color: black;
  margin: 12% auto;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  border-radius: 12px;
  animation: slideUp 0.3s ease;
}

/* Animationen */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

</style>
  
</head>

<body>

<h2>ğŸ“ ZweibrÃ¼cken<br>ğŸ•“ Mittwoch, 16â€“18 Uhr</h2>
<p id="weather" class="weather-link">Wetter wird geladenâ€¦</p>
  <div class="divider"></div>
  
  <!-- Wetter Modal -->
<div id="weatherModal" class="modal" onclick="closeWeather(event)">
  <div class="modal-content">
    <span class="close" onclick="closeWeather()">Ã—</span>
    <h3>ğŸŒ¦ï¸ Wetter Mittwoch 16â€“18 Uhr</h3>
    <div id="weatherDetails">Lade Detailsâ€¦</div>
  </div>
</div>

<h3>So Leute, wer ist am Start?</h3>

<input id="name" placeholder="Dein Name" style="width:100%;padding:8px">

<button id="btn-all" onclick="vote('Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»')">
  Laufen und essen ğŸƒğŸƒâ€â™€ï¸ğŸ» (0)
</button>

<button id="btn-run" onclick="vote('Nur Laufen ğŸƒğŸƒâ€â™€ï¸')">
  nur laufen ğŸƒğŸƒâ€â™€ï¸ (0)
</button>

<button id="btn-eat" onclick="vote('Nur Essen ğŸ»')">
  nur essen ğŸ» (0)
</button>

<button id="btn-out" onclick="vote('Ganz raus ğŸ›')">
  ganz raus ğŸ› (0)
</button>


<h3>ğŸ‘‡ Aktuelle Stimmen</h3>
<ul id="results" style="margin-top:12px;"></ul>
<script>
/* ğŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyDi3ZJKDa2o3YX9XmsTMqPu7R3U9DwLqiA",
  authDomain: "lauftreff-ad4df.firebaseapp.com",
  projectId: "lauftreff-ad4df"
});
const db = firebase.firestore();

// Name aus LocalStorage laden
const nameInput = document.getElementById("name");
const savedName = localStorage.getItem("userName");
if (savedName) {
  nameInput.value = savedName;
}

/* ğŸ”„ WÃ¶chentlicher Reset (Donnerstag) */
async function weeklyResetIfNeeded() {
  const metaRef = db.collection("meta").doc("reset");
  const snap = await metaRef.get();
  const lastReset = snap.exists ? snap.data().date : null;

  const now = new Date();
  const day = now.getDay(); // 4 = Donnerstag
  const week = getWeekNumber(now);

  if (day !== 4) return;
  if (lastReset === week) return;

  const votes = await db.collection("votes").get();
  const batch = db.batch();
  votes.forEach(doc => batch.delete(doc.ref));
  await batch.commit();

  await metaRef.set({ date: week });
  console.log("âœ… Reset durchgefÃ¼hrt");
}

function getWeekNumber(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getUTCFullYear()}-${weekNo}`;
}
weeklyResetIfNeeded();

// ğŸŒ¦ï¸ Wetter Modal Ã¶ffnen/schlieÃŸen
function openWeather(detailsHtml) {
  document.getElementById("weatherDetails").innerHTML = detailsHtml;
  document.getElementById("weatherModal").style.display = "block";
}

// SchlieÃŸen: X oder Klick auÃŸerhalb
function closeWeather(event) {
  const modal = document.getElementById("weatherModal");

  // Klick auÃŸerhalb des Fensters
  if (event && event.target !== modal) return;

  modal.style.display = "none";
}

/* ğŸ—³ï¸ Abstimmen */
function vote(choice) {
  const nameInput = document.getElementById("name");
  const name = nameInput.value.trim();
  if (!name) return alert("Name fehlt!");

  // Name speichern
  localStorage.setItem("userName", name);

  db.collection("votes").doc(name).set({
    choice: choice,
    time: new Date()
  });
}

/* ğŸ“Š Live-Ergebnisse + Button-ZÃ¤hler */
db.collection("votes").onSnapshot(snap => {
  const ul = document.getElementById("results");
  ul.innerHTML = "";

  // Namen pro Auswahl sammeln
  let grouped = {
    "Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»": [],
    "Nur Laufen ğŸƒğŸƒâ€â™€ï¸": [],
    "Nur Essen ğŸ»": [],
    "Ganz raus ğŸ›": []
  };

  snap.forEach(doc => {
    const name = doc.id;
    const choice = doc.data().choice;
    if (grouped[choice]) {
      grouped[choice].push(name);
    }
  });

  // Buttons aktualisieren
document.getElementById("btn-all").innerHTML =
  `Laufen und essen ğŸƒğŸƒâ€â™€ï¸ğŸ» <span class="count">${grouped["Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»"].length}</span>`;

document.getElementById("btn-run").innerHTML =
  `nur laufen ğŸƒğŸƒâ€â™€ï¸ <span class="count">${grouped["Nur Laufen ğŸƒğŸƒâ€â™€ï¸"].length}</span>`;

document.getElementById("btn-eat").innerHTML =
  `nur essen ğŸ» <span class="count">${grouped["Nur Essen ğŸ»"].length}</span>`;

document.getElementById("btn-out").innerHTML =
  `ganz raus ğŸ› <span class="count">${grouped["Ganz raus ğŸ›"].length}</span>`;


  // Zusammengefasste Anzeige unten
  Object.entries(grouped).forEach(([choice, names]) => {
    if (names.length > 0) {
      ul.innerHTML += `<li><strong>${choice}:</strong> ${names.join(", ")}</li>`;
    }
  });
});

/* ğŸŒ¦ï¸ Wetter */
  async function loadWeather() {
  const key = "d5c77bf99195c16c75fc8a78261769ff";
  const lat = 49.2478, lon = 7.3666;

  const r = await fetch(
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${key}`
  );
  const data = await r.json();

  let temps16_18 = [];
  let rain16_18 = false;
  let details = "";
  let minTemp = Infinity;
  let maxTemp = -Infinity;

  details += `<h4>Mittwoch (ab jetzt)</h4>`;

  data.list.forEach(e => {
    const d = new Date(e.dt * 1000);

    if (d.getDay() === 3) {
      const temp = e.main.temp;
      minTemp = Math.min(minTemp, temp);
      maxTemp = Math.max(maxTemp, temp);

      const hour = d.getHours();
      let section = "ğŸŒ™ Nacht";
      if (hour >= 6) section = "ğŸŒ… Morgen";
      if (hour >= 12) section = "â˜€ï¸ Nachmittag";
      if (hour >= 18) section = "ğŸŒ† Abend";

      const rainClass = e.rain ? "style='color:#1565c0;font-weight:bold'" : "";

      details += `
        <p ${rainClass}>
          ${section} Â· ğŸ•“ ${hour.toString().padStart(2, "0")}:00 â€“
          ğŸŒ¡ï¸ ${temp.toFixed(1)} Â°C â€“
          ${e.weather[0].description}
        </p>
      `;

      // Hauptanzeige 16â€“18 Uhr
      if (hour >= 16 && hour <= 18) {
        temps16_18.push(temp);
        if (e.rain) rain16_18 = true;
      }
    }
  });

  if (!temps16_18.length) return;

  const avg = (
    temps16_18.reduce((a, b) => a + b, 0) / temps16_18.length
  ).toFixed(1);

  const weatherEl = document.getElementById("weather");
  weatherEl.innerText =
    `ğŸŒ¦ï¸ ${avg} Â°C Â· es wird ${rain16_18 ? "regnen" : "nicht regnen"}`;

  details =
    `<p><strong>ğŸŒ¡ï¸ Heute: ${minTemp.toFixed(1)} â€“ ${maxTemp.toFixed(1)} Â°C</strong></p>` +
    details +
    `<p style="font-size:12px;color:#666;margin-top:10px;">
      â„¹ï¸ Vorhersage fÃ¼r Mittwoch, ab aktuellem Zeitpunkt
    </p>`;

  weatherEl.onclick = () => openWeather(details);
}
loadWeather();
</script>
