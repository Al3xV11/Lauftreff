<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mittwoch Umfrage</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 600px;
  margin: auto;
  padding: 12px;
}

h2 {
  font-size: 1.3em;
  text-align: center;
}

h3 {
  margin-top: 24px;
}

input {
  width: 100%;
  padding: 12px;
  font-size: 16px; /* verhindert iOS-Zoom */
  margin-bottom: 10px;
  box-sizing: border-box;
}

button {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  margin: 6px 0;
  border-radius: 8px;
  border: none;
  background: #f0f0f0;
  cursor: pointer;
}

button:active {
  background: #ddd;
}

#weather {
  text-align: center;
  font-size: 1.1em;
  margin-bottom: 16px;
}

ul {
  padding-left: 0;
}

li {
  list-style: none;
  padding: 6px 0;
  line-height: 1.4;
  font-size: 16px;
}
</style>
  
</head>

<body>

<h2>ğŸ“ ZweibrÃ¼cken<br>ğŸ•“ Mittwoch, 16â€“18 Uhr</h2>
<p id="weather">Wetter wird geladenâ€¦</p>

<h3>So Leute, wer ist am Mittwoch am Start?</h3>

<input id="name" placeholder="Dein Name" style="width:100%;padding:8px">

<button id="btn-all" onclick="vote('Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»')">
  Laufen und essen ğŸƒğŸƒâ€â™€ï¸ğŸ» (0)
</button>

<button id="btn-run" onclick="vote('Nur Laufen ğŸƒğŸƒâ€â™€ï¸')">
  nur laufen ğŸƒğŸƒâ€â™€ï¸ (0)
</button>

<button id="btn-eat" onclick="vote('Nur Essen ğŸ»')">
  nur essen ğŸ» (0)
</button>

<button id="btn-out" onclick="vote('Ganz raus ğŸ›')">
  ganz raus ğŸ› (0)
</button>


<h3>ğŸ‘‡ Aktuelle Stimmen</h3>
<ul id="results" style="margin-top:12px;"></ul>
<script>
/* ğŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyDi3ZJKDa2o3YX9XmsTMqPu7R3U9DwLqiA",
  authDomain: "lauftreff-ad4df.firebaseapp.com",
  projectId: "lauftreff-ad4df"
});
const db = firebase.firestore();

/* ğŸ”„ WÃ¶chentlicher Reset (Donnerstag) */
async function weeklyResetIfNeeded() {
  const metaRef = db.collection("meta").doc("reset");
  const snap = await metaRef.get();
  const lastReset = snap.exists ? snap.data().date : null;

  const now = new Date();
  const day = now.getDay(); // 4 = Donnerstag
  const week = getWeekNumber(now);

  if (day !== 4) return;
  if (lastReset === week) return;

  const votes = await db.collection("votes").get();
  const batch = db.batch();
  votes.forEach(doc => batch.delete(doc.ref));
  await batch.commit();

  await metaRef.set({ date: week });
  console.log("âœ… Reset durchgefÃ¼hrt");
}

function getWeekNumber(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getUTCFullYear()}-${weekNo}`;
}
weeklyResetIfNeeded();

/* ğŸ—³ï¸ Abstimmen */
function vote(choice) {
  const name = document.getElementById("name").value.trim();
  if (!name) return alert("Name fehlt!");
  db.collection("votes").doc(name).set({
    choice: choice,
    time: new Date()
  });
}

/* ğŸ“Š Live-Ergebnisse + Button-ZÃ¤hler */
db.collection("votes").onSnapshot(snap => {
  const ul = document.getElementById("results");
  ul.innerHTML = "";

  // Namen pro Auswahl sammeln
  let grouped = {
    "Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»": [],
    "Nur Laufen ğŸƒğŸƒâ€â™€ï¸": [],
    "Nur Essen ğŸ»": [],
    "Ganz raus ğŸ›": []
  };

  snap.forEach(doc => {
    const name = doc.id;
    const choice = doc.data().choice;
    if (grouped[choice]) {
      grouped[choice].push(name);
    }
  });

  // Buttons aktualisieren
  document.getElementById("btn-all").innerText =
    `Laufen und essen ğŸƒğŸƒâ€â™€ï¸ğŸ» (${grouped["Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»"].length})`;

  document.getElementById("btn-run").innerText =
    `nur laufen ğŸƒğŸƒâ€â™€ï¸ (${grouped["Nur Laufen ğŸƒğŸƒâ€â™€ï¸"].length})`;

  document.getElementById("btn-eat").innerText =
    `nur essen ğŸ» (${grouped["Nur Essen ğŸ»"].length})`;

  document.getElementById("btn-out").innerText =
    `ganz raus ğŸ› (${grouped["Ganz raus ğŸ›"].length})`;

  // Zusammengefasste Anzeige unten
  Object.entries(grouped).forEach(([choice, names]) => {
    if (names.length > 0) {
      ul.innerHTML += `<li><strong>${choice}:</strong> ${names.join(", ")}</li>`;
    }
  });
});

/* ğŸŒ¦ï¸ Wetter */
async function loadWeather() {
  const key = "d5c77bf99195c16c75fc8a78261769ff";
  const lat = 49.2478, lon = 7.3666;

  const r = await fetch(
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${key}`
  );
  const data = await r.json();

  let temps = [], rain = false;
  data.list.forEach(e => {
    const d = new Date(e.dt * 1000);
    if (d.getDay() === 3 && d.getHours() >= 16 && d.getHours() <= 18) {
      temps.push(e.main.temp);
      if (e.rain) rain = true;
    }
  });

  if (temps.length) {
    const avg = (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1);
    document.getElementById("weather").innerText =
      `ğŸŒ¦ï¸ ${avg} Â°C Â· Regen: ${rain ? "Ja" : "Nein"}`;
  }
}
loadWeather();
</script>
