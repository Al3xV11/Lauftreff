<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mittwoch Umfrage</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; max-width: 600px; margin: auto; }
button { display: block; width: 100%; margin: 6px 0; padding: 10px; font-size: 16px; }
</style>
</head>

<body>

<h2>ğŸ“ ZweibrÃ¼cken<br>ğŸ•“ Mittwoch, 16â€“18 Uhr</h2>
<p id="weather">Wetter wird geladenâ€¦</p>

<h3>So Leute, wer ist am Mittwoch am Start?</h3>

<input id="name" placeholder="Dein Name" style="width:100%;padding:8px">

<button id="btn-all" onclick="vote('Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»')">
  Laufen und essen ğŸƒğŸƒâ€â™€ï¸ğŸ» (0)
</button>

<button id="btn-run" onclick="vote('Nur Laufen ğŸƒğŸƒâ€â™€ï¸')">
  nur laufen ğŸƒğŸƒâ€â™€ï¸ (0)
</button>

<button id="btn-eat" onclick="vote('Nur Essen ğŸ»')">
  nur essen ğŸ» (0)
</button>

<button id="btn-out" onclick="vote('Ganz raus ğŸ›')">
  ganz raus ğŸ› (0)
</button>


<h3>ğŸ‘‡ Aktuelle Stimmen</h3>
<ul id="results"></ul>
<script>
/* ğŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyDi3ZJKDa2o3YX9XmsTMqPu7R3U9DwLqiA",
  authDomain: "lauftreff-ad4df.firebaseapp.com",
  projectId: "lauftreff-ad4df"
});
const db = firebase.firestore();

/* ğŸ”„ WÃ¶chentlicher Reset (Donnerstag) */
async function weeklyResetIfNeeded() {
  const metaRef = db.collection("meta").doc("reset");
  const snap = await metaRef.get();
  const lastReset = snap.exists ? snap.data().date : null;

  const now = new Date();
  const day = now.getDay(); // 4 = Donnerstag
  const week = getWeekNumber(now);

  if (day !== 4) return;
  if (lastReset === week) return;

  const votes = await db.collection("votes").get();
  const batch = db.batch();
  votes.forEach(doc => batch.delete(doc.ref));
  await batch.commit();

  await metaRef.set({ date: week });
  console.log("âœ… Reset durchgefÃ¼hrt");
}

function getWeekNumber(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getUTCFullYear()}-${weekNo}`;
}
weeklyResetIfNeeded();

/* ğŸ—³ï¸ Abstimmen */
function vote(choice) {
  const name = document.getElementById("name").value.trim();
  if (!name) return alert("Name fehlt!");
  db.collection("votes").doc(name).set({
    choice: choice,
    time: new Date()
  });
}

/* ğŸ“Š Live-Ergebnisse + Button-ZÃ¤hler */
db.collection("votes").onSnapshot(snap => {
  const ul = document.getElementById("results");
  ul.innerHTML = "";

  let counts = {
    "Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»": 0,
    "Nur Laufen ğŸƒğŸƒâ€â™€ï¸": 0,
    "Nur Essen ğŸ»": 0,
    "Ganz raus ğŸ›": 0
  };

  snap.forEach(doc => {
    const choice = doc.data().choice;
    ul.innerHTML += `<li>${doc.id} â†’ ${choice}</li>`;
    if (counts[choice] !== undefined) counts[choice]++;
  });

  document.getElementById("btn-all").innerText =
    `Laufen und essen ğŸƒğŸƒâ€â™€ï¸ğŸ» (${counts["Laufen & Essen ğŸƒğŸƒâ€â™€ï¸ğŸ»"]})`;

  document.getElementById("btn-run").innerText =
    `nur laufen ğŸƒğŸƒâ€â™€ï¸ (${counts["Nur Laufen ğŸƒğŸƒâ€â™€ï¸"]})`;

  document.getElementById("btn-eat").innerText =
    `nur essen ğŸ» (${counts["Nur Essen ğŸ»"]})`;

  document.getElementById("btn-out").innerText =
    `ganz raus ğŸ› (${counts["Ganz raus ğŸ›"]})`;
});

/* ğŸŒ¦ï¸ Wetter */
async function loadWeather() {
  const key = "d5c77bf99195c16c75fc8a78261769ff";
  const lat = 49.2478, lon = 7.3666;

  const r = await fetch(
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${key}`
  );
  const data = await r.json();

  let temps = [], rain = false;
  data.list.forEach(e => {
    const d = new Date(e.dt * 1000);
    if (d.getDay() === 3 && d.getHours() >= 16 && d.getHours() <= 18) {
      temps.push(e.main.temp);
      if (e.rain) rain = true;
    }
  });

  if (temps.length) {
    const avg = (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1);
    document.getElementById("weather").innerText =
      `ğŸŒ¦ï¸ ${avg} Â°C Â· Regen: ${rain ? "Ja" : "Nein"}`;
  }
}
loadWeather();
</script>
